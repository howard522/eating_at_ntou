name: Discord Notifications (Embed)

on:
    push:
        branches: [main, dev]

    pull_request:
        types: [opened, closed, reopened, synchronize]

    pull_request_review:
        types: [submitted]

    issues:
        types: [opened, closed, reopened]

    issue_comment: # ÂåÖÂê´ PR comments
        types: [created]

    watch:
        types: [started]

    fork:

jobs:
    notify:
        runs-on: ubuntu-slim

        steps:
            - name: Send embed to Discord
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
                  EVENT: ${{ github.event_name }}
                  ACTOR: ${{ github.actor }}
                  AVATAR_URL: https://github.com/${{ github.actor }}.png
              run: |
                  # Detect event type and construct embed content
                  case "$EVENT" in

                    push)
                      COLOR=3066993   # green
                      TITLE="üöÄ Push to ${GITHUB_REF##*/}"
                      DESC="${{ github.event.head_commit.message }}"
                      URL="${{ github.event.head_commit.url }}"
                      FOOT="commit ${{ github.event.head_commit.id }}"
                      ;;

                    pull_request)
                      if [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                        COLOR=10181046  # purple
                        TITLE="üü£ Pull Request Merged"
                      else
                        case "${{ github.event.action }}" in
                          opened)     COLOR=3066993;  TITLE="üü¢ PR Opened" ;;
                          closed)     COLOR=15158332; TITLE="üî¥ PR Closed" ;;
                          reopened)   COLOR=15844367; TITLE="üü° PR Reopened" ;;
                          synchronize) COLOR=3447003; TITLE="üîÑ PR Updated" ;;
                        esac
                      fi
                      TITLE="$TITLE: ${{ github.event.pull_request.title }}"
                      DESC="${{ github.event.pull_request.body }}"
                      URL="${{ github.event.pull_request.html_url }}"
                      FOOT="Pull Request #${{ github.event.pull_request.number }}"
                      ;;

                    pull_request_review)
                      COLOR=3447003  # blue
                      TITLE="üìù PR Review: ${{ github.event.pull_request.title }}"
                      DESC="${{ github.event.review.body }}"
                      URL="${{ github.event.review.html_url }}"
                      FOOT="Pull Request #${{ github.event.pull_request.number }}"
                      ;;

                    issues)
                      case "${{ github.event.action }}" in
                        opened) COLOR=3066993; TITLE="üü¢ Issue Opened" ;;
                        closed) COLOR=15158332; TITLE="üî¥ Issue Closed" ;;
                        reopened) COLOR=15844367; TITLE="üü° Issue Reopened" ;;
                      esac
                      TITLE="$TITLE: ${{ github.event.issue.title }}"
                      DESC=" ${{ github.event.issue.body }}"
                      URL="${{ github.event.issue.html_url }}"
                      FOOT="Issue #${{ github.event.issue.number }}"
                      ;;

                    issue_comment)
                      COLOR=3447003
                      TITLE="üí¨ New Comment on Issue#${{ github.event.issue.number }}"
                      DESC="${{ github.event.comment.body }}"
                      URL="${{ github.event.comment.html_url }}"
                      FOOT="Issue #${{ github.event.issue.number }}"
                      ;;

                    watch)
                      COLOR=15844367
                      TITLE="‚≠ê Repo Starred"
                      DESC="**User:** ${{ github.actor }}"
                      URL=""
                      FOOT="${GITHUB_REPOSITORY}"
                      ;;

                    fork)
                      COLOR=15105570
                      TITLE="üç¥ Repo Forked"
                      DESC="**User:** ${{ github.actor }}"
                      URL=""
                      FOOT="${GITHUB_REPOSITORY}"
                      ;;

                    *)
                      COLOR=8359053
                      TITLE="üì£ Event Triggered"
                      DESC="$EVENT event triggered."
                      URL=""
                      FOOT="${GITHUB_REPOSITORY}"
                      ;;
                  esac

                  # Escape fields safely
                  SAFE_TITLE=$(printf '%s' "$TITLE" | jq -Rs .)
                  SAFE_DESC=$(printf '%s' "$DESC" | jq -Rs .)
                  SAFE_URL=$(printf '%s' "$URL" | jq -Rs .)
                  SAFE_FOOT=$(printf '%s' "$FOOT" | jq -Rs .)
                  SAFE_ACTOR=$(printf '%s' "$ACTOR" | jq -Rs .)
                  SAFE_AVATAR=$(printf '%s' "$AVATAR_URL" | jq -Rs .)

                  # Build embed JSON
                  JSON=$(cat <<EOF
                  {
                    "embeds": [
                      {
                        "author": {
                            "name": $SAFE_ACTOR,
                            "icon_url": $SAFE_AVATAR
                        },
                        "title": $SAFE_TITLE,
                        "description": $SAFE_DESC,
                        "url": $SAFE_URL,
                        "color": $COLOR,
                        "footer": {
                          "text": $SAFE_FOOT
                        },
                        "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
                      }
                    ]
                  }
                  EOF
                  )

                  # Send to Discord
                  curl -H "Content-Type: application/json" \
                       -d "$JSON" \
                       "$DISCORD_WEBHOOK"
